# On RSpec

## Init RSpec on Rails

```bash
rails generate rspec:install
```

will generate the following archives:

```
spec/spec_helper.rb
spec/rails_helper.rb
.rspec
```


## Integrate shoulda-matchers with RSpec & Rails
Open `spec/rails_helper.rb` and configure shoulda matchers to use rspec as the test framework and full matcher libraries for rails. *At the end of the file* append:

```ruby
# Add additional requires below this line. Rails is not loaded until this point!
require 'shoulda/matchers'

Shoulda::Matchers.configure do |config|
  config.integrate do |with|
    with.test_framework :rspec
    with.library :rails
  end
end
```

## Configure Database cleaner
Open `spec/rails_helper.rb` and configure database cleaner, which starts by truncating all the tables but then use the faster transaction strategy the rest of the time:

```ruby
# Add additional requires below this line. Rails is not loaded until this point!
require 'database_cleaner'

RSpec.configure do |config|

  # transaction is usually the fastest strategy	
  config.before(:suite) do
    DatabaseCleaner.strategy = :transaction
    DatabaseCleaner.clean_with(:truncation)
  end

  # start the transaction strategy as examples are run
  config.around(:each) do |example|
    DatabaseCleaner.cleaning do
      example.run
    end
  end

end
```

## Configure .rspec
Open `.rspec` and enable coloring and automatically include `rails_helper` on every spec:
```
--color
--require rails_helper
--format Fuubar
```

## Update binstubs
```bash
rails app:update:bin
```

## RSpec binstub
You may want to create a binstub for the `rspec` command so it can be run via `rspec`:
```bash
bundle binstubs rspec-core
```

## Launch Postgres Test database
```bash
docker run --rm -it -p 5432:5432 -e POSTGRES_DB=music_hive_test --name music_hive_db postgres:9.5-alpine
```

test connection via `docker`:

```bash
docker run -it --rm --link music_hive_db:postgres postgres psql -h postgres -U postgres music_hive_test -c 'select 1;'
```

or locally via `psql`:

```bash
psql -h localhost -U postgres music_hive_test -c 'select 1;'
```

## Configure database for test environment
Edit `config/database.yml` and append `username` and `host` on `test:` environment:
```yml
test:
  <<: *default
  #...
  username: postgres
  host: localhost
```

## Re-Generate `bundle`
Your `bundle` was not generated by Bundler, so this binstub cannot run. Replace `bundle` by running:
```bash
bundle binstubs bundler --force
```

## Run RSpec first time!
First run pending migrations in test database:

```bash
rails db:migrate RAILS_ENV=test
```

then execute `rspec` binstub:

```bash
rspec
```
